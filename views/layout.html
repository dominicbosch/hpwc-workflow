<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>HPWC Workflow - {% block title %}{% endblock %}</title>
	<script type="text/javascript" src="../js/lib/jquery-1.11.2.min.js"></script>
	<link rel="stylesheet" href="../css/layout.css">
	{% if username %}
	<script type="text/javascript" src="../js/layout.js"></script>
	<script type="text/javascript">
	
		"use strict";

		var selectedConn = {
			name: '{{ selectedConnection.name }}',
			status: '{{ selectedConnection.status }}',
			projectName: '{{ selectedConnection.project.name }}' 
		};

		$(document).ready(function() {


			//Get the possible configuration and check for the current configuration reading the project
			$.get( '/services/configuration/getAll', function( data ) {

				if ( data ) {

					//put data inside "configs" element
					for ( var config in data ) {
						$( '#configs' ).append($( '<option>' ).attr( 'value', config ).text( config ) );
					}

					//Current configuration not empty
					if( selectedConn.name !== '' ) {

						//set current configuration, change event is not raised because the configuration details are read from the session
						$( '#configs' ).val( selectedConn.name );

						$( '#connectButton' ).text( selectedConn.status ? 'Disconnect' : 'Connect' );

						if( selectedConn.status ) {

							//retrieve project list if old connection is set and connected
							getAndSetProjects( selectedConn.name );
						}
						
						{% block ifconnectionextra %}{% endblock %}
					}
				}
			})
			.fail( function( xhr ) {
				console.log(' Request failed: (' + xhr.status + ') ' + xhr.statusText );
			});
		});

		function getAndSetProjects( config_name ) {

			//clean project list
			$( '#projects' ).html( '<option value="">Choose A Project</option>' );

			if( config_name !== '' ) {
				//read the projects for an open connection and set the values
				$.get( '/services/project/getAll/' + config_name, function( projects ) {
	
					for ( var i in projects ) {
						$( '#projects' ).append($( '<option>' ).attr( 'value', projects[i] ).text( projects[i] ) );
					}
	
					//Current project not empty
					if( selectedConn.projectName !== '' ) {
						//set current project, change event is not raised because the project details are read from the session
						$( '#projects' ).val( selectedConn.projectName );
		
						{% block ifprojectextra %}{% endblock %}
					}
				}).fail(function( xhr ) {
					console.log( xhr.responseText );
				});
			} 
		}
	</script>
	{% endif %}

	{% block head %}{% endblock %}

</head>
<body>
	<header>
		<a href="/views/index"><img src="../img/unilogo_HPWC_small.png"></a>
		<div></div>
	</header>
	<nav>
		<a href="/views/configuration">Configurations</a>
		<a href="/views/project">Project</a>
		<a href="/views/method">Method</a>
		<a href="/views/experiment">Experiment</a>
		<a href="/views/visualization">Visualization</a>
		{% if username %}
			<a href="/views/logout">Logout</a>
		{% else %}
			<a href="/views/login">Login</a>
			<a href="/views/register">Register</a>
		{% endif %}
	</nav>
	<section>
		<div class="left">
			{% block content_left %}{% endblock %}
		</div>
		<div class="right">
		{% if username %}
		{% block shared_content_right %}
			<div id="preview">
				<div id="conf_title">
					<h3>Current connection settings</h3>
					<select id="configs" name="configs">
						<option value="">Choose A Configuration</option>
					</select>
				</div>
				<table id="conf_table">
					<tr>
						<th>
							Hostname : 
						</th>
						<td name="hostname">
							{% if selectedConnection %}
								{{ configurations[ selectedConnection.name ][ 'name' ] }}
							{% else %}
								--
							{% endif %}
						</td>
					</tr>
					<tr>
						<th>
							Url : 
						</th>
						<td name="host">
							{% if selectedConnection %}
								{{ configurations[ selectedConnection.name ][ 'url' ] }}
							{% else %}
								--
							{% endif %}
						</td>
					</tr>
					<tr>
						<th>
							Username : 
						</th>
						<td name="username">
							{% if selectedConnection %}
								{{ configurations[ selectedConnection.name ][ 'username' ] }}
							{% else %}
								--
							{% endif %}
						</td>
					</tr>
					<tr>
						<th>
							Workflow path : 
						</th>
						<td name="workflow">
							{% if selectedConnection %}
								{{ configurations[ selectedConnection.name ][ 'workhome' ] }}
							{% else %}
								--
							{% endif %}
						</td>
					</tr>
					<tr>
						<th>
							Workspace path : 
						</th>
						<td name="workspace">
							{% if selectedConnection %}
								{{ configurations[ selectedConnection.name ][ 'workspace' ] }}
							{% else %}
								--
							{% endif %}
						</td>
					</tr>
				</table>
				<div class="centered-text">
					<button id="connectButton" onclick="toggleSelectedConnection( this )"
						{% if !selectedConnection %}disabled="true"{% endif %}>Connect</button>
				</div>
			</div>
		{% endblock %}
		{% endif %}
		{% block content_right %}{% endblock %}
		</div>
	</section>
	<footer>
	</footer>
</body>
</html>